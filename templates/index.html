<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>

    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>

    <h1>–£—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</h1>

    <div class="container">

        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
        <div class="form-container">
            <h2>–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</h2>
            <form hx-post="/spends"
                  hx-ext="json-enc"
                  hx-swap="none"
                  hx-on::after-request="
                    this.reset();
                    alert('–†–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!');
                    htmx.trigger('#spends-table', 'reload');
                  ">
                <div class="grid">
                    <div><label>–°—á—ë—Ç</label>
                        <select name="account" required>
                            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å—á—ë—Ç</option>
                            <option value="t-bank">T-bank</option>
                            <option value="sber">SBER</option>
                            <option value="alfa_visa">Alfa Visa</option>
                            <option value="alfa_mir">Alfa MIR</option>
                            <option value="t-bank_invest">T-Bank Invest</option>
                            <option value="exodus-btc">Crypto (Exodus)</option>
                        </select>
                    </div>
                    <div><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select name="category" required>
                            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            <option value="–ï–¥–∞">–ï–¥–∞</option>
                            <option value="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
                            <option value="–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
                            <option value="–ñ–∏–ª—å–µ">–ñ–∏–ª—å–µ</option>
                            <option value="–ó–¥–æ—Ä–æ–≤—å–µ">–ó–¥–æ—Ä–æ–≤—å–µ</option>
                            <option value="–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>
                    <div><label>–î–∞—Ç–∞</label><input type="date" name="date" required></div>
                    <div><label>–°—É–º–º–∞</label><input type="number" name="amount" step="0.01" min="0" required></div>
                    <div><label>–í–∞–ª—é—Ç–∞</label>
                        <select name="currency" required>
                            <option value="" disabled selected>–í–∞–ª—é—Ç–∞</option>
                            <option value="RUB">RUB ‚ÇΩ</option>
                            <option value="USD">USD $</option>
                            <option value="BTC">BTC ‚Çø</option>
                            <option value="ETH">ETH Œû</option>
                        </select>
                    </div>
                    <div><label>–¢–µ–≥</label>
                        <select name="labels">
                            <option value="">–ë–µ–∑ —Ç–µ–≥–∞</option>
                            <option value="spar">SPAR</option>
                            <option value="—à–∞—É—Ä–º–∞">–®–∞—É—Ä–º–∞</option>
                            <option value="–∫–æ—Ñ–µ">–ö–æ—Ñ–µ</option>
                            <option value="–ø—è—Ç–µ—Ä–æ—á–∫–∞">–ü—è—Ç—ë—Ä–æ—á–∫–∞</option>
                        </select>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <input type="text" name="note" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ">
                    </div>
                </div>
                <button type="submit">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
            </form>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ (–±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –∏–∑ JSON) -->
        <div class="table-container">
            <h2>–í—Å–µ —Ä–∞—Å—Ö–æ–¥—ã</h2>
            <div id="spends-table"
                 hx-get="/spends"
                 hx-trigger="load, reload from:body"
                 hx-swap="innerHTML"
                 hx-on::after-swap="renderTable(event.detail.xhr.response)">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤...</p>
            </div>
        </div>
    </div>

    <!-- –ó–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤—Å—è –º–∞–≥–∏—è ‚Äî —Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É –∏–∑ JSON -->
<script>
    function renderTable(jsonText) {
        let spends;
        try { spends = JSON.parse(jsonText); } 
        catch (e) {
            document.getElementById('spends-table').innerHTML = '<p style="color:red">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            return;
        }

        if (!spends.length) {
            document.getElementById('spends-table').innerHTML = '<p class="empty">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤<br>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π!</p>';
            return;
        }

        spends.sort((a, b) => new Date(b.date) - new Date(a.date));

        const currencySymbol = cur => ({
            RUB: '‚ÇΩ', USD: '$', BTC: '‚Çø', ETH: 'Œû'
        }[cur] || cur);

        const rows = spends.map(s => `
            <tr id="row-${s.id}">
                <td data-label="–î–∞—Ç–∞">${new Date(s.date).toLocaleDateString('ru-RU')}</td>
                <td data-label="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">${s.category || '‚Äî'}</td>
                <td data-label="–°—á—ë—Ç">${s.account || '‚Äî'}</td>
                <td data-label="–û–ø–∏—Å–∞–Ω–∏–µ" class="note">${s.note || '‚Äî'}</td>
                <td data-label="–¢–µ–≥">${s.labels ? `<span class="tag">${s.labels}</span>` : '‚Äî'}</td>
                <td data-label="–°—É–º–º–∞" class="amount">
                    ${parseFloat(s.amount).toLocaleString('ru-RU')} ${currencySymbol(s.currency)}
                </td>
                <td style="white-space: nowrap; text-align: center;">
                    <!-- Edit button with pencil icon -->
                    <button class="edit-btn" 
                            hx-get="/spends/${s.id}/edit"
                            hx-target="#row-${s.id}"
                            hx-swap="innerHTML"
                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                        ‚úèÔ∏è
                    </button>

                    <!-- Delete button with trash icon -->
                    <button class="delete-btn"
                            hx-delete="/spends/${s.id}" 
                            hx-confirm="–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞—Å—Ö–æ–¥?"
                            hx-target="#row-${s.id}"
                            hx-swap="outerHTML"
                            hx-on::after-request="if(event.detail.successful) htmx.trigger('#spends-table', 'reload')"
                            title="–£–¥–∞–ª–∏—Ç—å">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>
        `).join('');

        document.getElementById('spends-table').innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th>–°—á—ë—Ç</th>
                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        <th>–¢–µ–≥</th>
                        <th>–°—É–º–º–∞</th>
                        <th style="width:90px; text-align:center;">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;
        htmx.process(document.getElementById('spends-table'));
    }
</script>

</body>
</html>